<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>SkyCast PRO ‚Ä¢ Genzie Vibe</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SkyCast">
    <link rel="apple-touch-icon" href="https://openweathermap.org/img/wn/02d@2x.png">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { 
            --bg: #0f172a; 
            --pink: #ff007a; 
            --blue: #38bdf8; 
            --glass: rgba(255, 255, 255, 0.08); 
            --text: #ffffff; 
        }
        
        body { 
            margin: 0; 
            font-family: 'Lexend', -apple-system, sans-serif; 
            background: var(--bg); 
            background-image: radial-gradient(circle at top right, #1e1b4b, #0f172a);
            color: var(--text); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh;
            padding-top: env(safe-area-inset-top);
        }

        header { 
            padding: 20px; 
            font-size: 1.8rem; 
            font-weight: 900; 
            background: linear-gradient(to right, var(--pink), var(--blue)); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            text-transform: uppercase; 
        }

        main { width: 100%; max-width: 450px; padding: 10px 15px 40px 15px; box-sizing: border-box; }

        .card { 
            background: var(--glass); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 30px; 
            padding: 20px; 
            margin-bottom: 20px; 
        }

        .btn-main { 
            background: var(--pink); border: none; color: white; padding: 16px; 
            border-radius: 20px; font-weight: 800; width: 100%; text-transform: uppercase; 
            cursor: pointer; box-shadow: 0 5px 15px rgba(255, 0, 122, 0.3); margin-bottom: 20px;
        }

        #map { height: 350px; width: 100%; border-radius: 25px; z-index: 1; background: #000; border: 1px solid rgba(255,255,255,0.1); }
        
        .layer-selector { 
            display: flex; gap: 8px; overflow-x: auto; padding-bottom: 15px; 
            scrollbar-width: none; -ms-overflow-style: none;
        }
        .layer-selector::-webkit-scrollbar { display: none; }

        .layer-btn { 
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); 
            color: white; padding: 10px 18px; border-radius: 15px; font-size: 0.75rem; 
            white-space: nowrap; cursor: pointer; transition: 0.2s;
        }
        .layer-btn.active { background: var(--pink); border-color: var(--pink); font-weight: bold; }

        .slider-box { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 20px; margin-top: 10px; }
        input[type=range] { width: 100%; accent-color: var(--pink); cursor: pointer; }
        
        #radar-time { font-size: 0.85rem; font-weight: bold; color: var(--pink); text-align: center; display: block; margin-bottom: 5px; }
        .temp-big { font-size: 4rem; font-weight: 800; margin: 0; line-height: 1; }
        canvas { width: 100% !important; height: 180px !important; }
        
        .legend-labels { display: flex; justify-content: space-between; font-size: 0.65rem; opacity: 0.6; margin-top: 5px; font-weight: bold; }
        
        .leaflet-control-scale-line { 
            background: rgba(0,0,0,0.5) !important; color: white !important; 
            border: 1px solid var(--pink) !important; text-shadow: none !important; 
        }
    </style>
</head>
<body>

<header>SkyCast x Genzie</header>

<main>
    <button class="btn-main" onclick="locateMe()">üìç GDZIE JA JESTEM? (VIBE CHECK)</button>

    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <div id="city" style="color: var(--blue); font-weight: 800; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px;">Warszawa</div>
                <h1 class="temp-big" id="main-temp">--¬∞</h1>
            </div>
            <div id="main-icon"></div>
        </div>
        <div id="advice" style="margin-top:18px; font-size: 0.95rem; line-height: 1.4; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px;">
            Czekam na dane... No cap, zaraz dobierzemy fit! üß•
        </div>
    </div>

    <div class="card">
        <h3 style="margin:0 0 15px 0; font-size: 0.8rem; color: var(--pink); text-transform: uppercase; letter-spacing: 1px;">Prognoza godzinowa üî•</h3>
        <canvas id="tempChart"></canvas>
    </div>

    <div class="card" style="padding: 12px;">
        <div class="layer-selector">
            <button class="layer-btn active" onclick="setLayer('radar', this)">üåßÔ∏è Opady</button>
            <button class="layer-btn" onclick="setLayer('temp_new', this)">üå°Ô∏è Temp</button>
            <button class="layer-btn" onclick="setLayer('wind_new', this)">üí® Wiatr</button>
            <button class="layer-btn" onclick="setLayer('pressure_new', this)">‚è≤Ô∏è Ci≈õnienie</button>
        </div>
        
        <div id="map"></div>
        
        <div class="slider-box" id="radar-ui">
            <span id="radar-time">Wczytujƒô radar...</span>
            <input type="range" id="radar-slider" min="0" max="0" value="0" oninput="updateRadarFrame(this.value)">
            <div class="legend-labels">
                <span>HISTORIA</span>
                <span>TERAZ</span>
                <span>PROGNOZA</span>
            </div>
        </div>
        <div id="map-msg" style="text-align: center; font-size: 0.8rem; margin-top: 10px; color: var(--blue); font-weight: bold;"></div>
    </div>
</main>

<script>
    const API_KEY = "07c3b3e89d44a0eeb75b69e69c4b2264";
    let map = L.map('map', { zoomControl: false, attributionControl: false }).setView([52.23, 21.01], 6);
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    L.control.scale({ imperial: false, position: 'bottomright' }).addTo(map);

    let radarLayers = [], radarFrames = [], owmLayer = null, tempChart = null;

    function setLayer(type, btn) {
        document.querySelectorAll('.layer-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        if (owmLayer) map.removeLayer(owmLayer);
        radarLayers.forEach(l => map.removeLayer(l));
        
        const radarUI = document.getElementById('radar-ui');
        
        if (type === 'radar') {
            radarUI.style.display = 'block';
            loadRadar();
        } else {
            radarUI.style.display = 'none';
            owmLayer = L.tileLayer(`https://tile.openweathermap.org/map/${type}/{z}/{x}/{y}.png?appid=${API_KEY}`, {
                opacity: 0.7, zIndex: 100
            }).addTo(map);
        }
    }

    async function loadRadar() {
        try {
            const res = await fetch("https://api.rainviewer.com/public/weather-maps.json");
            const data = await res.json();
            radarFrames = [...data.radar.past, ...data.radar.nowcast];
            
            radarLayers.forEach(l => map.removeLayer(l));
            radarLayers = radarFrames.map(f => L.tileLayer(`https://tilecache.rainviewer.com/v2/radar/${f.time}/256/{z}/{x}/{y}/2/1_1.png`, {
                opacity: 0, zIndex: 200
            }).addTo(map));

            const slider = document.getElementById('radar-slider');
            slider.max = radarFrames.length - 1;
            slider.value = radarFrames.length - 1;
            updateRadarFrame(slider.value);
        } catch(e) { console.log("Radar error"); }
    }

    function updateRadarFrame(idx) {
        radarLayers.forEach((l, i) => l.setOpacity(i == idx ? 0.8 : 0));
        const date = new Date(radarFrames[idx].time * 1000);
        const hours = date.getHours().toString().padStart(2, '0');
        const mins = date.getMinutes().toString().padStart(2, '0');
        document.getElementById('radar-time').innerText = `CZAS: ${hours}:${mins}`;
    }

    async function fetchAll(lat, lon) {
        try {
            const [curRes, foreRes] = await Promise.all([
                fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&lang=pl&appid=${API_KEY}`),
                fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=metric&lang=pl&appid=${API_KEY}`)
            ]);
            const current = await curRes.json();
            const forecast = await foreRes.json();
            updateUI(current, forecast);
        } catch(e) { console.log("Weather error"); }
    }

    function updateUI(cur, fore) {
        document.getElementById('city').innerText = cur.name;
        document.getElementById('main-temp').innerText = Math.round(cur.main.temp) + "¬∞";
        document.getElementById('main-icon').innerHTML = `<img src="https://openweathermap.org/img/wn/${cur.weather[0].icon}@2x.png" width="80">`;
        
        const t = cur.main.temp;
        let advice = t > 20 ? "Jest hot! üî• Kr√≥tki rƒôkaw i lecimy nagrywaƒá!" : t > 10 ? "Vibe chillowy, bluza Genzie starczy. üß•" : "Mrozi! ü•∂ Gruba kurtka i herbata. No cap.";
        if(cur.weather[0].main.includes("Rain")) advice += " We≈∫ parasol, bo bƒôdzie drama! ‚òî";
        document.getElementById('advice').innerText = advice;

        if (tempChart) tempChart.destroy();
        tempChart = new Chart(document.getElementById('tempChart'), {
            type: 'line',
            data: {
                labels: fore.list.slice(0, 8).map(i => new Date(i.dt * 1000).getHours() + ":00"),
                datasets: [{
                    data: fore.list.slice(0, 8).map(i => i.main.temp),
                    borderColor: '#ff007a',
                    backgroundColor: 'rgba(255, 0, 122, 0.1)',
                    fill: true, tension: 0.4, pointRadius: 5, pointBackgroundColor: '#fff'
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: false },
                scales: {
                    x: { ticks: { color: '#fff' }, grid: { display: false } },
                    y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                }
            }
        });
    }

    function locateMe() {
        navigator.geolocation.getCurrentPosition(p => {
            const lat = p.coords.latitude, lon = p.coords.longitude;
            map.setView([lat, lon], 10);
            fetchAll(lat, lon);
        }, () => alert("Musisz w≈ÇƒÖczyƒá lokalizacjƒô w Safari! üìç"));
    }

    // Inicjalizacja na start
    loadRadar();
    fetchAll(52.23, 21.01); 
</script>

</body>
</html>
