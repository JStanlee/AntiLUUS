<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>SkyCast PRO ‚Ä¢ Genzie Vibe</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0f172a; --pink: #ff007a; --blue: #38bdf8; --glass: rgba(255, 255, 255, 0.08); --text: #ffffff; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        header { padding: 20px; font-size: 1.8rem; font-weight: 900; background: linear-gradient(to right, var(--pink), var(--blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-transform: uppercase; }
        main { width: 100%; max-width: 450px; padding: 10px 15px 40px 15px; box-sizing: border-box; }
        .card { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 30px; padding: 20px; margin-bottom: 20px; }
        .btn-main { background: var(--pink); border: none; color: white; padding: 16px; border-radius: 20px; font-weight: 800; width: 100%; text-transform: uppercase; cursor: pointer; margin-bottom: 20px; }
        #map { height: 350px; width: 100%; border-radius: 25px; z-index: 1; background: #000; }
        .layer-selector { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 15px; scrollbar-width: none; }
        .layer-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 10px 18px; border-radius: 15px; font-size: 0.75rem; white-space: nowrap; cursor: pointer; }
        .layer-btn.active { background: var(--pink); border-color: var(--pink); }
        .slider-box { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 20px; margin-top: 10px; }
        input[type=range] { width: 100%; accent-color: var(--pink); }
        #radar-time { font-size: 0.85rem; font-weight: bold; color: var(--pink); text-align: center; display: block; }
        .temp-big { font-size: 4rem; font-weight: 800; margin: 0; }
        canvas { width: 100% !important; height: 180px !important; }
    </style>
</head>
<body>

<header>SkyCast x Genzie</header>

<main>
    <button class="btn-main" onclick="locateMe()">üìç NAMIERZ MNIE (VIBE CHECK)</button>

    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <div id="city" style="color: var(--blue); font-weight: 800; font-size: 0.85rem; text-transform: uppercase;">Warszawa</div>
                <h1 class="temp-big" id="main-temp">--¬∞</h1>
            </div>
            <div id="main-icon"></div>
        </div>
        <div id="advice" style="margin-top:10px; font-size: 0.95rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px;">≈Åadowanie fitu... üß•</div>
    </div>

    <div class="card">
        <h3 style="margin:0 0 15px 0; font-size: 0.8rem; color: var(--pink); text-transform: uppercase;">Prognoza na nastƒôpne 24h üìà</h3>
        <canvas id="tempChart"></canvas>
    </div>

    <div class="card" style="padding: 12px;">
        <div class="layer-selector">
            <button class="layer-btn active" onclick="setLayer('radar', this)">üåßÔ∏è Opady</button>
            <button class="layer-btn" onclick="setLayer('temp_new', this)">üå°Ô∏è Temp</button>
            <button class="layer-btn" onclick="setLayer('wind_new', this)">üí® Wiatr</button>
            <button class="layer-btn" onclick="setLayer('pressure_new', this)">‚è≤Ô∏è Ci≈õnienie</button>
        </div>
        <div id="map"></div>
        <div class="slider-box" id="radar-ui">
            <span id="radar-time">Wczytujƒô radar...</span>
            <input type="range" id="radar-slider" min="0" max="0" value="0" oninput="updateRadarFrame(this.value)">
        </div>
    </div>
</main>

<script>
    const API_KEY = "07c3b3e89d44a0eeb75b69e69c4b2264";
    let map = L.map('map', { zoomControl: false, attributionControl: false }).setView([52.23, 21.01], 6);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

    let radarLayers = [], radarFrames = [], owmLayer = null, tempChart = null;

    function setLayer(type, btn) {
        document.querySelectorAll('.layer-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if (owmLayer) map.removeLayer(owmLayer);
        radarLayers.forEach(l => map.removeLayer(l));
        document.getElementById('radar-ui').style.display = (type === 'radar') ? 'block' : 'none';
        if (type === 'radar') loadRadar();
        else owmLayer = L.tileLayer(`https://tile.openweathermap.org/map/${type}/{z}/{x}/{y}.png?appid=${API_KEY}`, { opacity: 0.7, zIndex: 100 }).addTo(map);
    }

    async function loadRadar() {
        const res = await fetch("https://api.rainviewer.com/public/weather-maps.json");
        const data = await res.json();
        radarFrames = [...data.radar.past, ...data.radar.nowcast];
        radarLayers.forEach(l => map.removeLayer(l));
        radarLayers = radarFrames.map(f => L.tileLayer(`https://tilecache.rainviewer.com/v2/radar/${f.time}/256/{z}/{x}/{y}/2/1_1.png`, { opacity: 0, zIndex: 200 }).addTo(map));
        document.getElementById('radar-slider').max = radarFrames.length - 1;
        updateRadarFrame(radarFrames.length - 1);
    }

    function updateRadarFrame(idx) {
        radarLayers.forEach((l, i) => l.setOpacity(i == idx ? 0.8 : 0));
        const date = new Date(radarFrames[idx].time * 1000);
        document.getElementById('radar-time').innerText = `CZAS: ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
    }

    async function fetchWeather(lat, lon) {
        const [cRes, fRes] = await Promise.all([
            fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&lang=pl&appid=${API_KEY}`),
            fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=metric&lang=pl&appid=${API_KEY}`)
        ]);
        const cur = await cRes.json();
        const fore = await fRes.json();

        document.getElementById('city').innerText = cur.name;
        document.getElementById('main-temp').innerText = Math.round(cur.main.temp) + "¬∞";
        document.getElementById('main-icon').innerHTML = `<img src="https://openweathermap.org/img/wn/${cur.weather[0].icon}@2x.png" width="80">`;
        
        // FILTROWANIE DANYCH DO WYKRESU (TYLKO PRZYSZ≈ÅO≈öƒÜ)
        const now = Math.floor(Date.now() / 1000);
        const futureData = fore.list.filter(item => item.dt > now).slice(0, 8);

        if (tempChart) tempChart.destroy();
        tempChart = new Chart(document.getElementById('tempChart'), {
            type: 'line',
            data: {
                labels: futureData.map(i => new Date(i.dt * 1000).getHours() + ":00"),
                datasets: [{
                    data: futureData.map(i => i.main.temp),
                    borderColor: '#ff007a',
                    backgroundColor: 'rgba(255, 0, 122, 0.1)',
                    fill: true, tension: 0.4, pointRadius: 5, pointBackgroundColor: '#fff'
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: false }, scales: { x: { ticks: { color: '#fff' } }, y: { ticks: { color: '#fff' } } } }
        });
    }

    function locateMe() {
        navigator.geolocation.getCurrentPosition(p => {
            map.setView([p.coords.latitude, p.coords.longitude], 10);
            fetchWeather(p.coords.latitude, p.coords.longitude);
        });
    }

    loadRadar();
    fetchWeather(52.23, 21.01);
</script>
</body>
</html>
