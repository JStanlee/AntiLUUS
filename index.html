<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>SkyCast PRO ‚Ä¢ Genzie</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://openweathermap.org/img/wn/10d@2x.png">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --p: #ff007a; --b: #38bdf8; --bg: #0f172a; --g: rgba(255, 255, 255, 0.1); }
        body { margin: 0; font-family: 'Lexend', sans-serif; background: var(--bg); color: #fff; display: flex; flex-direction: column; align-items: center; }
        header { padding: 30px 20px 10px; font-size: 2rem; font-weight: 900; background: linear-gradient(45deg, var(--p), var(--b)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        main { width: 100%; max-width: 450px; padding: 15px; box-sizing: border-box; }
        
        .card { background: var(--g); backdrop-filter: blur(15px); border-radius: 25px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .btn-loc { background: var(--p); border: none; color: #fff; padding: 15px; border-radius: 15px; width: 100%; font-weight: 800; text-transform: uppercase; cursor: pointer; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(255,0,122,0.4); }
        
        #map { height: 350px; width: 100%; border-radius: 20px; background: #000; }
        .temp-val { font-size: 4.5rem; font-weight: 800; margin: 0; line-height: 1; }
        
        .selector { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 15px; scrollbar-width: none; }
        .sel-btn { background: rgba(255,255,255,0.15); border: none; color: #fff; padding: 10px 18px; border-radius: 12px; white-space: nowrap; cursor: pointer; font-size: 0.8rem; }
        .sel-btn.active { background: var(--p); font-weight: bold; }
        
        .slider-wrap { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 15px; margin-top: 10px; text-align: center; }
        input[type=range] { width: 100%; accent-color: var(--p); }
        
        canvas { width: 100% !important; height: 180px !important; }
        #advice-text { font-style: italic; color: var(--b); font-weight: 600; }
    </style>
</head>
<body>

<header>SKYCAST x GENZIE</header>

<main>
    <button class="btn-loc" onclick="geoLocate()">üìç NAMIERZ MNIE (REL!)</button>

    <div class="card">
        <div style="display:flex; justify-content: space-between;">
            <div>
                <div id="city-name" style="text-transform: uppercase; font-weight: 800; color: var(--b);">Warszawa</div>
                <h1 class="temp-val" id="curr-temp">--¬∞</h1>
                <div id="curr-desc" style="opacity: 0.8; margin-top: 5px;">Sprawdzam vibe...</div>
            </div>
            <div id="curr-icon"></div>
        </div>
        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
            <div id="advice-text">Czekaj na info o ficie... üß•</div>
        </div>
    </div>

    <div class="card">
        <h3 style="margin: 0 0 15px 0; font-size: 0.8rem; color: var(--p);">PROGNOZA NA NASTƒòPNE 24H üìà</h3>
        <canvas id="weatherChart"></canvas>
    </div>

    <div class="card" style="padding: 10px;">
        <div class="selector">
            <button class="sel-btn active" onclick="updateMap('radar', this)">üåßÔ∏è Radar</button>
            <button class="sel-btn" onclick="updateMap('temp_new', this)">üå°Ô∏è Temp</button>
            <button class="sel-btn" onclick="updateMap('wind_new', this)">üí® Wiatr</button>
            <button class="sel-btn" onclick="updateMap('pressure_new', this)">‚è≤Ô∏è Ci≈õnienie</button>
        </div>
        
        <div id="map"></div>
        
        <div class="slider-wrap" id="radar-ui">
            <div id="time-display" style="font-weight: bold; margin-bottom: 5px;">Czas: TERAZ</div>
            <input type="range" id="time-slider" min="0" max="0" value="0" oninput="changeRadarFrame(this.value)">
        </div>
    </div>
</main>

<script>
    const API_KEY = "07c3b3e89d44a0eeb75b69e69c4b2264";
    let map = L.map('map', { zoomControl: false, attributionControl: false }).setView([52.23, 21.01], 6);
    
    // Ciemne t≈Ço mapy
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

    let radarFrames = [], radarLayers = [], currentTileLayer = null, chart = null;

    // 1. LOKALIZACJA
    function geoLocate() {
        navigator.geolocation.getCurrentPosition(p => {
            const lat = p.coords.latitude, lon = p.coords.longitude;
            map.setView([lat, lon], 10);
            fetchData(lat, lon);
        }, () => alert("Musisz kliknƒÖƒá 'Zezw√≥l' w Safari!"));
    }

    // 2. POBIERANIE DANYCH
    async function fetchData(lat, lon) {
        const [cRes, fRes] = await Promise.all([
            fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&lang=pl&appid=${API_KEY}`),
            fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=metric&lang=pl&appid=${API_KEY}`)
        ]);
        
        const cur = await cRes.json();
        const fore = await fRes.json();
        
        // Update UI
        document.getElementById('city-name').innerText = cur.name;
        document.getElementById('curr-temp').innerText = Math.round(cur.main.temp) + "¬∞";
        document.getElementById('curr-desc').innerText = cur.weather[0].description;
        document.getElementById('curr-icon').innerHTML = `<img src="https://openweathermap.org/img/wn/${cur.weather[0].icon}@2x.png" width="80">`;
        
        // GENZIE ADVICE
        const t = cur.main.temp;
        let advice = "";
        if(t > 20) advice = "Jest hot! üî• Kr√≥tki rƒôkaw i lecimy nagrywaƒá TikToka!";
        else if(t > 10) advice = "Vibe chillowy, bluza Genzie starczy. No cap, jest git! üß•";
        else advice = "Mrozi! ü•∂ Gruba kurtka i herbata. No cap, nie daj siƒô przeziƒôbiƒá!";
        if(cur.weather[0].main === "Rain") advice += " We≈∫ parasol, bo bƒôdzie drama! ‚òî";
        document.getElementById('advice-text').innerText = advice;

        // CHART (Future only)
        const now = Math.floor(Date.now() / 1000);
        const future = fore.list.filter(i => i.dt > now).slice(0, 8);
        renderChart(future);
    }

    // 3. WYKRES PROGNOZY
    function renderChart(data) {
        const ctx = document.getElementById('weatherChart').getContext('2d');
        if(chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(i => new Date(i.dt * 1000).getHours() + ":00"),
                datasets: [{
                    data: data.map(i => i.main.temp),
                    borderColor: '#ff007a',
                    backgroundColor: 'rgba(255, 0, 122, 0.2)',
                    fill: true, tension: 0.4, pointRadius: 5, pointBackgroundColor: '#fff'
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: false }, scales: { x: { ticks: { color: '#fff' } }, y: { ticks: { color: '#fff' } } } }
        });
    }

    // 4. MAPA I WARSTWY
    async function updateMap(type, btn) {
        document.querySelectorAll('.sel-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        if(currentTileLayer) map.removeLayer(currentTileLayer);
        radarLayers.forEach(l => map.removeLayer(l));
        document.getElementById('radar-ui').style.display = (type === 'radar' ? 'block' : 'none');

        if(type === 'radar') {
            loadRadar();
        } else {
            currentTileLayer = L.tileLayer(`https://tile.openweathermap.org/map/${type}/{z}/{x}/{y}.png?appid=${API_KEY}`, {
                opacity: 0.8, zIndex: 100
            }).addTo(map);
        }
    }

    async function loadRadar() {
        const res = await fetch("https://api.rainviewer.com/public/weather-maps.json");
        const data = await res.json();
        radarFrames = [...data.radar.past, ...data.radar.nowcast];
        
        radarLayers = radarFrames.map(f => L.tileLayer(`https://tilecache.rainviewer.com/v2/radar/${f.time}/256/{z}/{x}/{y}/2/1_1.png`, {
            opacity: 0, zIndex: 200
        }).addTo(map));

        const slider = document.getElementById('time-slider');
        slider.max = radarFrames.length - 1;
        slider.value = radarFrames.length - 1;
        changeRadarFrame(slider.value);
    }

    function changeRadarFrame(idx) {
        radarLayers.forEach((l, i) => l.setOpacity(i == idx ? 0.8 : 0));
        const date = new Date(radarFrames[idx].time * 1000);
        document.getElementById('time-display').innerText = `Czas: ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
    }

    // START
    loadRadar();
    fetchData(52.23, 21.01);
</script>
</body>
</html>
